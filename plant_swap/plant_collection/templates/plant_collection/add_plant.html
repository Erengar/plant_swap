{% extends "base.html" %}
{% block content %}
<style>
    output .image span {
        position: absolute;
        top: -4px;
        right: 4px;
        cursor: pointer;
        font-size: 22px;
        color: white;
      }
      
      output .image span:hover {
        opacity: 0.8;
      }
      
      output .span--hidden{
        visibility: hidden;
      }
</style>
<form enctype='multipart/form-data' class='box' action="{% url 'plant_collection:add_plant' %}" method='post'>
    {% csrf_token %}

        <div class='field'>
            <label class='label pt-3'>{{ form.nick_name.label_tag }}</label>
            <div class='control'>{{ form.nick_name }}</div>
        </div>
        {% if form.nick_name.errors %}
            <div>
                <ul>
                    {% for error in form.nick_name.errors %}
                        <li class='has-text-danger'>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <div class='field'>
            <label class='label pt-3'>{{ form.species.label_tag }}</label>
            <div class='control'>{{ form.species }}</div>
        </div>
        {% if form.species.errors %}
            <div>
                <ul>
                    {% for error in form.species.errors %}
                        <li class='has-text-danger'>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <div class='input_container' id='replicator'>
            <div class='field' id='hiding0'>
                <div id='file-js-example' class='file is-medium is-boxed'>
                    <label class='file-label pt-3'>
                        <input class='input_tag0 file_input' id='input_tag0' hidden type='file' accept='image/*' name='picture0'>
                        <span class='file-cta'>
                            <span class='file-icon'>
                                <i class='fa-solid fa-image'></i>
                            </span>
                            <span class='file-label'>
                                Upload image...
                            </span>
                        </span>
                    </label>
                </div>
            </div>
        </div>

        {% if form.picture.errors %}
            <div>
                <ul>
                    {% for error in form.picture.errors %}
                        <li class='has-text-danger'>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    <div class='container'>
        <input id='submit-btn' class='button' type="submit" value='Submit'>
    </div>
</form>
<output class='columns'></output>

<script>
    /*
    In this script we are listening to input_container class for any change, that is file input.
    Once image is inserted into input, we display it, then hide used input tag and spawn new one.
    In this way we are protecting input tags from getting new image which would be messing with our display of images and event listener.
    Cross on the picture also removes given picture from post request.
    */


    const output = document.querySelector('output');
    var input = document.querySelector('.input_tag0');
    const inputContainer = document.querySelector('#replicator');
    let count = 0;
    let counti = 0;
    let imagesArray = [];

    //Listening to object that will contain all file input fields, „change“ should fine as long as we are adding and hiding fields
    inputContainer.addEventListener("change", () => {
        var files = input.files
        imagesArray.push(files)
        displayImages()
        addInput()
        removeInput()
      })

    
    function removeInput() {
        let node = document.getElementById(`hiding${counti}`);
        let hid = document.createAttribute('hidden');
        node.setAttributeNode(hid);
        counti ++

    }
    
    //Needs different variable, because it starts counting from 1, as 0 is already placed in html
    function addInput() {
        count ++
        const inputHtml = document.createRange().createContextualFragment(
                            `<div class='field' id='hiding${count}'>
                            <div id='file-js-example' class='file is-medium is-boxed'>
                                <label class='file-label pt-3'>
                                    <input class='input_tag${count} file-input' id='input_tag${count}' hidden type='file' accept='image/*' name='picture${count}'>
                                    <span class='file-cta'>
                                        <span class='file-icon'>
                                            <i class='fa-solid fa-image'></i>
                                        </span>
                                        <span class='file-label'>
                                            Upload image
                                        </span>
                                    </span>
                                </label>
                            </div>
                        </div>`);
        //before was innerHtml +=, turned out it was invalidating input fields
        inputContainer.appendChild(inputHtml);
        input = document.querySelector(`.input_tag${count}`);
    }

    function displayImages() {
        let images = "";
        imagesArray.forEach((image, index) => {
            for (let i = 0; i < image.length; i++) {
                images += `<div class='column is-3'>
                              <div class="image is-4by3">
                              <img src="${URL.createObjectURL(image[i])}" alt="image">
                              <span onclick="deleteImage(${index}, ${i})">&times;</span>
                            </div>
                            </div>`;
            }
        });
        output.innerHTML = images;
    }

    function deleteImage(index) {
        let nod = document.getElementById(`input_tag${index}`);
        let dis = document.createAttribute('disabled');
        nod.setAttributeNode(dis)
        imagesArray.splice(index, 1)
        displayImages()
      }

  </script>
{% endblock %}